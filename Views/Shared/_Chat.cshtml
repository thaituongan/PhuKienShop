<!-- Chat Widget -->
<div id="chat-widget" class="chat-widget">
    <div class="chat-header">
        <h5>Live Chat @User.Identity.Name <span id="toggleChat" class="toggle-chat">[Hide]</span></h5>
    </div>
    <div id="messages" class="chat-messages"></div>
    <div class="chat-input-container">
        <input type="text" id="messageInput" placeholder="Enter your message..." class="form-control" />
        <button id="sendButton" class="btn btn-primary">Send</button>
    </div>
</div>

<button id="toggleChatButton" class="btn btn-info chat-toggle-button">Chat</button>

<input type="hidden" id="userName" value="@User.Identity.Name" />

<!-- SignalR Script and Chat Widget Logic -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .configureLogging(signalR.LogLevel.Information)
            .build();

        connection.on("ReceiveMessage", (user, message) => {
            const msg = document.createElement("div");
            msg.className = user === "@User.Identity.Name" ? "chat-message user-messageWedget" : "chat-message admin-messageWedget";
            msg.innerHTML = `<strong>${user}</strong>: ${message}`;
            document.getElementById("messages").appendChild(msg);
            document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
        });

        connection.start()
            .then(() => {
                console.log("SignalR connected.");
                document.getElementById("sendButton").disabled = false;
            })
            .catch(err => console.error("SignalR connection failed: " + err.toString()));

        document.getElementById("sendButton").addEventListener("click", () => {
            const user = document.getElementById("userName").value;
            const message = document.getElementById("messageInput").value;
            if (message.trim()) {
                connection.invoke("SendMessageToAdmin", user, message)
                    .catch(err => console.error("Error sending message: " + err.toString()));
                document.getElementById("messageInput").value = "";
            }
        });

        let chatWidgetVisible = false;
        document.getElementById("toggleChatButton").addEventListener("click", () => {
            chatWidgetVisible = !chatWidgetVisible;
            document.getElementById("chat-widget").style.display = chatWidgetVisible ? "block" : "none";
        });

        document.getElementById("toggleChat").addEventListener("click", () => {
            chatWidgetVisible = !chatWidgetVisible;
            document.getElementById("chat-widget").style.display = chatWidgetVisible ? "block" : "none";
        });
    });
</script>

<style>
    .chat-widget {
        z-index: 1000;
        position: fixed;
        bottom: 0;
        right: 0;
        width: 350px;
        background-color: #f8f9fa;
        border: 1px solid #ccc;
        border-radius: 8px;
        display: none;
        flex-direction: column;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .chat-header {
        background-color: #007bff;
        color: white;
        padding: 10px;
        border-bottom: 1px solid #ccc;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .toggle-chat {
        cursor: pointer;
    }

    .chat-messages {
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        background-color: #fff;
    }

    .chat-message {
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 10px;
        max-width: 70%;
        word-wrap: break-word;
    }

    .user-messageWedget {
        background-color: #d1e7dd;
        align-self: flex-end;
        justify-content: flex-end;
    }

    .admin-messageWedget {
        background-color: #f8d7da;
        align-self: flex-start;
        justify-content: flex-start;
    }

    .chat-input-container {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ccc;
        background-color: #f1f1f1;
    }

    .chat-input-container input {
        flex: 1;
        margin-right: 5px;
    }

    .chat-toggle-button {
        position: fixed;
        bottom: 10px;
        right: 10px;
    }
</style>
